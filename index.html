<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lombardia - Selezione Comune + Report Indicatori</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- TopoJSON client -->
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    .app {
      height: 100%;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr; /* mappa | report */
    }

    .left {
      display: grid;
      grid-template-rows: auto 1fr;
      border-right: 1px solid #e8e8e8;
      min-width: 320px;
    }

    .toolbar {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 10px;
      border-bottom: 1px solid #e8e8e8;
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: end;
      background: #fff;
    }

    label { font-size: 12px; opacity: .75; display: block; margin-bottom: 4px; }

    select, button {
      padding: 10px;
      border: 1px solid #d8d8d8;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }
    select { width: 100%; }
    button { cursor: pointer; }
    #map { width: 100%; height: 100%; }

    .right {
      display: grid;
      grid-template-rows: auto 1fr;
      background: #fafafa;
    }
    .report-head {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid #e8e8e8;
      background: #fff;
    }
    .report-head h2 {
      margin: 0 0 6px 0;
      font-size: 16px;
      font-weight: 700;
    }
    .report-head .sub {
      font-size: 13px;
      opacity: .75;
      line-height: 1.3;
    }

    .report-body {
      padding: 12px 14px;
      overflow: auto;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .empty {
      padding: 12px;
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.35;
    }

    details {
      background: #fff;
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      margin: 10px 0;
      overflow: hidden;
    }

    summary {
      list-style: none;
      cursor: pointer;
      padding: 12px 12px;
      display: grid;
      grid-template-columns: 10px 1fr auto;
      align-items: center;
      gap: 10px;
      user-select: none;
      font-weight: 700;
      font-size: 14px;
    }
    summary::-webkit-details-marker { display: none; }

    .cat-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #999;
    }

    .cat-count {
      font-size: 12px;
      opacity: .7;
      font-weight: 600;
    }

    .cat-content {
      padding: 0 12px 12px 12px;
      border-top: 1px solid #f0f0f0;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #f2f2f2;
    }
    .row:last-child { border-bottom: none; }

    .ind-name {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.25;
    }
    .ind-code {
      font-size: 12px;
      opacity: .65;
      margin-top: 2px;
    }
    .ind-method {
      font-size: 12px;
      opacity: .75;
      margin-top: 6px;
      line-height: 1.25;
    }

    .ind-val {
      font-variant-numeric: tabular-nums;
      font-size: 14px;
      font-weight: 800;
      align-self: start;
      white-space: nowrap;
      padding-left: 10px;
    }

    .muted {
      opacity: .6;
      font-weight: 600;
    }

    /* Colori categoria 0-6 (puoi cambiarli) */
    .c0 { background:#5B8FF9; }
    .c1 { background:#61DDAA; }
    .c2 { background:#65789B; }
    .c3 { background:#F6BD16; }
    .c4 { background:#7262fd; }
    .c5 { background:#78D3F8; }
    .c6 { background:#F6903D; }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .left { border-right: none; border-bottom: 1px solid #e8e8e8; }
    }
  </style>
</head>

<body>
<div class="app">
  <div class="left">
    <div class="toolbar">
      <div>
        <label for="provSel">Provincia</label>
        <select id="provSel" disabled>
          <option value="">Caricamento…</option>
        </select>
      </div>

      <div>
        <label for="comSel">Comune</label>
        <select id="comSel" disabled>
          <option value="">Seleziona prima una provincia</option>
        </select>
      </div>

      <div>
        <button id="resetBtn" type="button">Reset</button>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <div class="right">
    <div class="report-head">
      <h2 id="reportTitle">Report comunale</h2>
      <div class="sub" id="reportSub">
        Seleziona un comune dalla mappa o dal menu per vedere le 7 categorie di indicatori.
      </div>
    </div>
    <div class="report-body" id="reportBody">
      <div class="empty">
        Nessun comune selezionato.<br><br>
        Suggerimento: clicca una <b>provincia</b>, poi seleziona un <b>comune</b>.
      </div>
    </div>
  </div>
</div>

<script>
  /************************************************************
   * DATI: JSON (da mettere nella stessa cartella di index.html)
   ************************************************************/
  const META_URL = "./indicator_meta.json";
  const DATA_URL = "./commune_data.json";

  // Confini (openpolis/geojson-italy) - TopoJSON
  const TOPO_URL =
    "https://raw.githubusercontent.com/openpolis/geojson-italy/master/topojson/limits_IT_all.topo.json";

  const REGION_NAME = "Lombardia";

  // Proprietà nel TopoJSON openpolis
  const G = {
    regName: "reg_name",
    provName: "prov_name",
    provCode: "prov_istat_code",
    comName: "name",
    comProvCode: "prov_istat_code"
  };

  /************************************************************
   * MAPPA (basemap politica: CARTO Voyager)
   ************************************************************/
  const map = L.map("map", { zoomControl: true, maxBoundsViscosity: 1.0 });

  // ✅ CARTO Voyager (politica/stradale)
  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
    {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }
  ).addTo(map);

  const provSel = document.getElementById("provSel");
  const comSel  = document.getElementById("comSel");
  const resetBtn = document.getElementById("resetBtn");

  let provinces = [];
  let communesTopo = [];
  let provLayer = null;
  let comLayer = null;
  let lombardiaBounds = null;
  let selectedProvCode = null;

  function safe(p, k) { return (p && p[k] != null) ? String(p[k]) : ""; }

  function clearSelect(sel, placeholder) {
    sel.innerHTML = "";
    const o = document.createElement("option");
    o.value = "";
    o.textContent = placeholder;
    sel.appendChild(o);
  }

  function setOptions(sel, items, placeholder) {
    clearSelect(sel, placeholder);
    for (const it of items) {
      const o = document.createElement("option");
      o.value = it.value;
      o.textContent = it.label;
      sel.appendChild(o);
    }
  }

  function fitTo(layer) {
    const b = layer.getBounds();
    if (b && b.isValid()) map.fitBounds(b, { padding: [16, 16] });
  }

  // (opzionale) look più “istituzionale”
  function styleProv(code) {
    const isSel = code && code === selectedProvCode;
    return {
      color: "#1f2a44",
      weight: isSel ? 3 : 1.5,
      fillOpacity: isSel ? 0.20 : 0.12
    };
  }

  function styleCom(isSel) {
    return {
      color: "#2c3e66",
      weight: isSel ? 2.5 : 1,
      fillOpacity: isSel ? 0.25 : 0.08
    };
  }

  function drawProvinces() {
    if (provLayer) provLayer.remove();

    provLayer = L.geoJSON(
      { type: "FeatureCollection", features: provinces },
      {
        style: (f) => styleProv(safe(f.properties, G.provCode)),
        onEachFeature: (f, layer) => {
          const name = safe(f.properties, G.provName) || "Provincia";
          const code = safe(f.properties, G.provCode);
          layer.bindTooltip(name, { sticky: true });

          layer.on("click", () => {
            if (code) selectProvince(code);
          });
        }
      }
    ).addTo(map);
  }

  function drawCommunes(filtered) {
    if (comLayer) comLayer.remove();

    comLayer = L.geoJSON(
      { type: "FeatureCollection", features: filtered },
      {
        style: () => styleCom(false),
        onEachFeature: (f, layer) => {
          const name = safe(f.properties, G.comName) || "Comune";
          layer.bindTooltip(name, { sticky: true });

          layer.on("click", () => {
            const cname = safe(f.properties, G.comName);
            comSel.value = cname;
            highlightComuneOnMap(cname);
            renderReportForComune(cname);
          });
        }
      }
    ).addTo(map);
  }

  function highlightComuneOnMap(name) {
    if (!name || !comLayer) return;

    comLayer.eachLayer(l => {
      const cname = safe(l.feature?.properties, G.comName);
      l.setStyle(styleCom(cname === name));
      if (cname === name) {
        try { map.fitBounds(l.getBounds(), { padding: [16,16], maxZoom: 12 }); } catch {}
      }
    });
  }

  function selectProvince(code) {
    selectedProvCode = code;

    drawProvinces();
    provSel.value = code;

    const filtered = communesTopo.filter(f => safe(f.properties, G.comProvCode) === code);

    const items = filtered
      .map(f => safe(f.properties, G.comName))
      .filter(Boolean)
      .sort((a,b) => a.localeCompare(b, "it"))
      .map(n => ({ value: n, label: n }));

    comSel.disabled = false;
    setOptions(comSel, items, "Seleziona un comune");

    drawCommunes(filtered);

    const provFeat = provinces.find(f => safe(f.properties, G.provCode) === code);
    if (provFeat) {
      const tmp = L.geoJSON(provFeat);
      fitTo(tmp);
      tmp.remove();
    }
  }

  function resetAll() {
    selectedProvCode = null;

    if (comLayer) comLayer.remove();
    comLayer = null;

    comSel.disabled = true;
    clearSelect(comSel, "Seleziona prima una provincia");

    provSel.value = "";
    drawProvinces();

    if (lombardiaBounds) map.fitBounds(lombardiaBounds, { padding: [20, 20] });

    setEmptyReport();
  }

  provSel.addEventListener("change", e => {
    const code = e.target.value;
    if (code) selectProvince(code);
    else resetAll();
  });

  comSel.addEventListener("change", e => {
    const cname = e.target.value;
    if (!cname) return;
    highlightComuneOnMap(cname);
    renderReportForComune(cname);
  });

  resetBtn.addEventListener("click", resetAll);

  /************************************************************
   * REPORT (indicator_meta.json + commune_data.json)
   ************************************************************/
  const reportTitle = document.getElementById("reportTitle");
  const reportSub   = document.getElementById("reportSub");
  const reportBody  = document.getElementById("reportBody");

  let meta = null;
  let dataRows = null;
  let rowByComune = new Map();

  function normComuneName(s) {
    return String(s || "")
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function setEmptyReport() {
    reportTitle.textContent = "Report comunale";
    reportSub.textContent = "Seleziona un comune dalla mappa o dal menu per vedere le 7 categorie di indicatori.";
    reportBody.innerHTML = `
      <div class="empty">
        Nessun comune selezionato.<br><br>
        Suggerimento: clicca una <b>provincia</b>, poi seleziona un <b>comune</b>.
      </div>
    `;
  }

  function formatValue(v) {
    if (v === null || v === undefined || v === "") return "<span class='muted'>n.d.</span>";
    if (typeof v === "number") return v.toLocaleString("it-IT", { maximumFractionDigits: 4 });
    return String(v);
  }

  function colorClassForCat(cat) { return "c" + String(cat); }

  function buildIndicatorsByCat() {
    const m = new Map();
    for (const ind of meta.indicators) {
      const c = ind.cat;
      if (!m.has(c)) m.set(c, []);
      m.get(c).push(ind);
    }
    return m;
  }

  function renderReportForComune(comuneName) {
    if (!meta || !dataRows) return;

    const key = normComuneName(comuneName);
    const row = rowByComune.get(key);

    reportTitle.textContent = `Report: ${comuneName}`;
    reportSub.textContent = "Indicatori organizzati in 7 categorie (menu a scomparsa).";

    if (!row) {
      reportBody.innerHTML = `
        <div class="empty">
          Comune <b>${comuneName}</b> non trovato nella colonna <b>Amm_2</b> della “Banca dati”.<br><br>
          Possibili cause: differenze di scrittura (spazi, apostrofi, accenti).
        </div>
      `;
      return;
    }

    const byCat = buildIndicatorsByCat();
    const cats = [...meta.categories].sort((a,b) => a.cat - b.cat);

    reportBody.innerHTML = cats.map(c => {
      const catId = c.cat;
      const catName = c.name;
      const items = byCat.get(catId) || [];
      const dotClass = colorClassForCat(catId);

      const rowsHtml = items.map(ind => {
        const v = row[ind.code];
        const methodHtml = ind.method ? `<div class="ind-method">${ind.method}</div>` : "";
        return `
          <div class="row">
            <div>
              <div class="ind-name">${ind.label}</div>
              <div class="ind-code">${ind.code}</div>
              ${methodHtml}
            </div>
            <div class="ind-val">${formatValue(v)}</div>
          </div>
        `;
      }).join("");

      return `
        <details>
          <summary>
            <span class="cat-dot ${dotClass}"></span>
            <span>${catId}) ${catName}</span>
            <span class="cat-count">${items.length} indicatori</span>
          </summary>
          <div class="cat-content">
            ${rowsHtml || "<div class='muted' style='padding:10px 0;'>Nessun indicatore in questa categoria.</div>"}
          </div>
        </details>
      `;
    }).join("");
  }

  async function loadJSON(url) {
    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) throw new Error(`Errore download ${url}: ${res.status}`);
    return await res.json();
  }

  /************************************************************
   * INIT
   ************************************************************/
  (async function init() {
    try {
      // 1) carico meta + dati
      meta = await loadJSON(META_URL);
      dataRows = await loadJSON(DATA_URL);

      rowByComune = new Map();
      for (const r of dataRows) {
        const n = normComuneName(r.Amm_2);
        if (n) rowByComune.set(n, r);
      }

      // 2) carico confini
      const topo = await loadJSON(TOPO_URL);

      const keys = Object.keys(topo.objects || {});
      const provKey = keys.find(k => k.toLowerCase().includes("prov"));
      const comKey  = keys.find(k => k.toLowerCase().includes("munic") || k.toLowerCase().includes("com"));
      if (!provKey || !comKey) throw new Error("Non riesco a riconoscere i layer province/comuni nel TopoJSON.");

      const provGeo = topojson.feature(topo, topo.objects[provKey]);
      const comGeo  = topojson.feature(topo, topo.objects[comKey]);

      provinces = (provGeo.features || []).filter(f => safe(f.properties, G.regName) === REGION_NAME);
      communesTopo = (comGeo.features || []).filter(f => safe(f.properties, G.regName) === REGION_NAME);

      if (!provinces.length) throw new Error("Filtro Lombardia: nessuna provincia trovata.");

      // bounds Lombardia + blocco uscita
      const lombLayer = L.geoJSON({ type: "FeatureCollection", features: provinces });
      lombardiaBounds = lombLayer.getBounds();

      map.fitBounds(lombardiaBounds, { padding: [20, 20] });
      map.setMaxBounds(lombardiaBounds);
      map.setMinZoom(map.getZoom());
      map.setMaxZoom(13);

      // menu province
      const provItems = provinces
        .map(f => ({
          value: safe(f.properties, G.provCode),
          label: safe(f.properties, G.provName) || safe(f.properties, G.provCode)
        }))
        .filter(x => x.value)
        .sort((a,b) => a.label.localeCompare(b.label, "it"));

      provSel.disabled = false;
      setOptions(provSel, provItems, "Seleziona una provincia");

      // disegna province + report vuoto
      drawProvinces();
      setEmptyReport();

    } catch (err) {
      console.error(err);
      alert("Errore inizializzazione: " + err.message);
      provSel.disabled = true;
      clearSelect(provSel, "Errore caricamento");
      setEmptyReport();
    }
  })();
</script>
</body>
</html>
